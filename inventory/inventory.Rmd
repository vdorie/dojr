---
title: "MACR Data Inventory"
output:
  pdf_document:
    includes:
      in_header: ../common/src/styles.sty
    keep_tex: true
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
targetType <- if (is.null(targetType <- knitr::opts_knit$get("rmarkdown.pandoc.to"))) "latex" else targetType

## This file is written from the assumption that it sits in a folder structure such as:
## root \
##   - common \
##     - data
##   - projectName \
##     file.Rmd
##
## and will look for a target file in ../common/data, which is to be shared by all projects

datasetName <- "MACR"
datasetDir  <- "macr"

dataPath <- file.path("..", "common", "data")

imgPath <- file.path(datasetDir, "img")
txtPath <- file.path(datasetDir, "txt")

dir.create(imgPath, showWarnings = FALSE, recursive = TRUE)
dir.create(txtPath, showWarnings = FALSE, recursive = TRUE)

tables <- read.csv(file.path(datasetDir, "tables.csv"), stringsAsFactors = FALSE)

mainTable <- tables$name[which.max(tables$main_table == 1L)]

dataLoaded <- rep(FALSE, nrow(tables))
names(dataLoaded) <- tables$name

loadData <- function(tableName = mainTable) {
  tableIndex <- which.max(tables$name == tableName)
  if (!dataLoaded[[tableName]]) {
    dataFilePath <- file.path(dataPath, tables$file[tableIndex])
    if (grepl("\\.csv$", tables$file[tableIndex])) {
      .GlobalEnv[[tables$object[tableIndex]]] <- read.csv(dataFilePath, stringsAsFactors = FALSE)
    } else if (grepl("\\.Rdata$", tables$file[tableIndex])) {
      load(dataFilePath, envir = .GlobalEnv)
    } else if (grepl("\\.dta$", tables$file[tableIndex])) {
      require(foreign)
      .GlobalEnv[[tables$object[tableIndex]]] <- read.dta(dataFilePath)
    } else {
      stop("unrecognized file format: '", tables$file[tableIndex], "'")
    }
    if (!is.na(tables$on_load[tableIndex]) && tables$on_load[tableIndex] != "")
      eval(parse(text = tables$on_load[tableIndex]), .GlobalEnv)
  }
  .GlobalEnv$dataLoaded[[tableName]] <- TRUE
  
  invisible(get(tables$object[tableIndex]))
}

## load some utilities
commonSrcPath <- file.path("..", "common", "src")
source(file.path(commonSrcPath, "knitr.R"))
source(file.path(commonSrcPath, "util.R"))

## inventory specific
srcPath <- file.path("src")
invisible(sapply(list.files(srcPath, "*.R", full.names = TRUE), source))

## data-set specific
dataSrcPath <- file.path(datasetDir, "src")
if (file.exists(file.path(dataSrcPath, "init.R"))) source(file.path(dataSrcPath, "init.R"))
```

# Abstract

# Introduction

# Tables

```{r tables_summary, echo=FALSE, results="asis"}
for (i in seq_len(nrow(tables))) {
  cat("### ", tables$display_name[i], "\n\n", sep = "")
  if (tables$description[i] != "")
    cat(tables$description[i], "\n\n", sep = "")
  
  firstFive <- formatFirstFiveRows(tables$name[i])
  if (length(firstFive) != 1L || firstFive != "")
    cat("#### Sample Rows\n\n", firstFive, "\n", sep = "\n")
  
  variablesSummary <- summarizeVariables(tables$name[i])
  if (length(variablesSummary) != 1L || variablesSummary != "")
    cat("#### Variable Summary\n\n", rmdFormat(variablesSummary), sep = "\n")
}
rm(firstFive, variablesSummary)
```

`r if (targetType == "latex") "\n\\newpage\n\n"`

# Main Table Variables

```{r main_table_variables, echo=FALSE, results="asis"}
variables <- read.csv(file.path(datasetDir, paste0(mainTable, "_variables.csv")),
                      stringsAsFactors = FALSE)

for (i in seq_len(nrow(variables))) {
  if (targetType == "latex" && i > 1L) cat("\n\\newpage\n\n")
  variable <- variables[i,]
  cat("### ", variable[["name"]], "\n\n", sep = "")
  if (variable[["value_labels"]] != "") cat("#### Labels\n\n", variable[["value_labels"]], "\n\n", sep = "")
  if (variable[["question_text"]] != "") cat("#### Prompt\n\n", variable[["question_text"]], "\n\n", sep = "")
  if (variable[["notes"]] != "") cat("#### Notes\n\n", variable[["notes"]], "\n\n", sep = "")
  
  if (!is.null(variable[["contains_pii"]]) && variable[["contains_pii"]] == 1L) next
  
  variableSummary <- summarizeVariable(variable[["name"]])
  if (length(variableSummary) != 1L || variableSummary != "") {
    cat("#### Summary\n\n")
    cat(variableSummary, sep = "\n")
    cat("\n")
  }
}
rm(variable, variableSummary)
```


```{r child = if (file.exists(cleanFile <- file.path(datasetDir, "clean.Rmd"))) cleanFile else NULL }
```
